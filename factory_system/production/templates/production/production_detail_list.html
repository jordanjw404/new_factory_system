{% extends "core/base.html" %}
{% load widget_tweaks dict_extras %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <h2 class="mb-0">Detailed Production List</h2>
    <a href="{% url 'production:production_list' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Summary
    </a>
  </div>

  <div class="collapse p-3 border rounded bg-light mb-3" id="productionFilters">
    <form method="get" class="row gx-2 gy-2 align-items-end">
      {% for field in filter.form.visible_fields %}
        <div class="col-md-3">
          {{ field.label_tag }} {{ field|add_class:"form-select form-select-sm" }}
        </div>
      {% endfor %}
      <div class="col-md-2 text-end">
        <button type="submit" class="btn btn-sm btn-primary w-100">Filter</button>
        <a href="{% url 'production:production_detail_list' %}" class="btn btn-sm btn-outline-secondary w-100 mt-2">Clear</a>
      </div>
    </form>
  </div>

  <p class="text-muted small ms-2">
    Showing {{ stages|length }} result{{ stages|length|pluralize }}.
  </p>

  <div class="table-responsive mt-3">
    <table id="productionDetailTable" class="table table-hover table-bordered table-sm text-center align-middle nowrap w-100">
      <thead class="table-dark">
        <tr>
          <th>Order Ref</th>
          <th>Customer</th>
          {% for field in status_fields %}
            <th>{{ field|capfirst }}</th>
            <th>Date</th>
          {% endfor %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for stage in stages %}
        <tr>
          <td>{{ stage.order.reference }}</td>
          <td>{{ stage.order.customer.name }}</td>
          {% for field in status_fields %}
          <td>
            <div class="dropdown position-relative" " data-stage-id="{{ stage.id }}">
              <a class="badge bg-{{ badge_colors|get_item:stage.id|get_item:field|default:'secondary' }} dropdown-toggle text-decoration-none"
                 href="#" role="button" id="dropdownMenu{{ field|capfirst }}{{ stage.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                {{ stage|get_attr:field|default:"-" }}
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenu{{ field|capfirst }}{{ stage.id }}">
                <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ stage.id }}', '{{ field }}_status', 'NOT_STARTED')">Not Started</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ stage.id }}', '{{ field }}_status', 'IN_PROGRESS')">In Progress</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ stage.id }}', '{{ field }}_status', 'STUCK')">Stuck</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ stage.id }}', '{{ field }}_status', 'ON_HOLD')">On Hold</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ stage.id }}', '{{ field }}_status', 'COMPLETED')">Completed</a></li>
                <li><a class="dropdown-item" href="#" onclick="updateStatus('{{ stage.id }}', '{{ field }}_status', 'Ready')">Ready</a></li>
              </ul>
            </div>
          </td>
          <td>{{ stage|get_target_date:field|date:"d M" }}</td>
          {% endfor %}
          <td>
            <div class="btn-group btn-group-sm">
              <a href="{% url 'production:production_detail' stage.id %}" class="btn btn-outline-primary" title="View"><i class="bi bi-eye"></i></a>
              <a href="{% url 'production:production_edit' stage.id %}" class="btn btn-outline-warning" title="Edit"><i class="bi bi-pencil-square"></i></a>
              <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ stage.id }}"><i class="bi bi-trash3"></i></button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="100">No production stages found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center my-3 container">
  <a href="{% url 'production:production_list' %}" class="btn btn-sm btn-outline-secondary">⬅️ Back to Summary</a>
  <a href="{% url 'production:production_detail_export' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-success">⬇️ Export to Excel</a>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    $('#productionDetailTable').DataTable({
      scrollX: true,
      autoWidth: false,
      paging: true,
      ordering: true,
      searching: true,
      info: true,
      responsive: false,
      language: {
        searchPlaceholder: "Quick Search...",
        search: "",
        lengthMenu: "_MENU_ entries per page",
        paginate: {
          previous: "<",
          next: ">"
        }
      }
    });
  });
</script>
{% endblock %}
