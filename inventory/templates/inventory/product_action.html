{% extends "core/base.html" %}
{% load crispy_forms_tags %}
{% block title %}Inventory · Action{% endblock %}
{% block nav_title %}{{ product.sku }} — IN / OUT / MOVE{% endblock %}
{% block content %}
<div class="container" style="max-width: 960px;">

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags|default:'info' }} py-2">{{ m }}</div>
    {% endfor %}
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger py-2">{{ form.non_field_errors }}</div>
  {% endif %}

  <div class="row">
    <div class="col-lg-6">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div><strong>{{ product.sku }}</strong><div class="small text-muted">{{ product.name }}</div></div>
          <a href="{% url 'inventory:stock_list' %}" class="btn btn-sm btn-outline-secondary">← Back</a>
        </div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            {{ form|crispy }}
            <button class="btn btn-primary mt-2">Submit</button>
            <a href="{% url 'inventory:stock_txn_list' %}" class="btn btn-link mt-2">Transactions</a>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card mb-3">
        <div class="card-header">Per-location balances</div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead><tr><th>Location</th><th class="text-end">On-hand</th></tr></thead>
            <tbody>
              {% for b in per_loc %}
                <tr><td>{{ b.location_code }}</td><td class="text-end">{{ b.qty_on_hand }}</td></tr>
              {% empty %}
                <tr><td colspan="2" class="text-center text-muted py-3">No stock yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleFields() {
    const opEl = document.getElementById("id_operation");
    if (!opEl) return;
    const op = opEl.value;
    const fromDiv = document.getElementById("fromFields");
    const toDiv   = document.getElementById("toFields");
    if (fromDiv) fromDiv.style.display = (op === "OUT" || op === "MOVE") ? "" : "none";
    if (toDiv)   toDiv.style.display   = (op === "IN"  || op === "MOVE") ? "" : "none";
  }
  document.addEventListener("DOMContentLoaded", () => {
    const opSel = document.getElementById("id_operation");
    if (opSel) { opSel.addEventListener("change", toggleFields); toggleFields(); }
  });
</script>
{% endblock %}
